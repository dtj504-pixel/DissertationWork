name: Time test

on: workflow_dispatch

jobs:
  timing-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        script:
          - name: "case_study8"
            file: "case_study8.R"
          - name: "looped_ver_case_study8_multi_point_EI"
            file: "looped_ver_case_study8_multi_point_EI.R"
          - name: "looped_ver_case_study8_multi_point_AEI"
            file: "looped_ver_case_study8_multi_point_AEI.R"
          - name: "looped_ver_case_study8_KG"
            file: "looped_ver_case_study8_KG.R"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Install R packages
        run: |
          Rscript -e 'install.packages(c("DiceKriging","dplyr","plot3D","stats"))'
      
      - name: Setup virtual display
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          export DISPLAY=:99
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
      
      - name: Time ${{ matrix.script.name }}
        run: |
          export DISPLAY=:99
          echo "Timing ${{ matrix.script.name }}..."
          start=$(date +%s.%N)
          Rscript ${{ matrix.script.file }}
          end=$(date +%s.%N)
          runtime=$(echo "$end - $start" | bc)
          echo "Runtime: ${runtime}s"
          echo "${runtime}" > timing_result.txt
      
      - name: Upload timing result
        uses: actions/upload-artifact@v4
        with:
          name: timing-${{ matrix.script.name }}
          path: timing_result.txt

  summary:
    needs: timing-tests
    runs-on: ubuntu-latest
    steps:
      - name: Download all timing results
        uses: actions/download-artifact@v4
      
      - name: Display summary
        run: |
          echo "=== Execution Time Summary ==="
          for dir in timing-*; do
            name=${dir#timing-}
            time=$(cat "$dir/timing_result.txt")
            echo "$name: ${time}s"
          done