<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Emma Bowen">

<title>Explanation of Mathematical Methods Behind the Second Half of the Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/clipboard/clipboard.min.js"></script>
<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/popper.min.js"></script>
<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/anchor.min.js"></script>
<link href="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Explanation of Mathematical Methods From Second Half of the Project_files/libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Explanation of Mathematical Methods From Second Half of the Project_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Explanation of Mathematical Methods From Second Half of the Project_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Explanation of Mathematical Methods From Second Half of the Project_files/libs/bootstrap/bootstrap-55aa396ea3e988129bcec43acf404917.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Explanation of Mathematical Methods Behind the Second Half of the Project</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Emma Bowen </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>What mathematical methods will I explain in this document that have not been explained in <a href="https://github.com/dtj504-pixel/DissertationWork/blob/main/Explanation%20of%20Mathematical%20Methods%20From%20First%20Half%20of%20the%20Project.qmd">Explanation of Mathematical Methods from First Half of the Project</a>?</p>
<ul>
<li><p>The basics of the MixME model</p>
<ul>
<li><p>Creating the operating model</p></li>
<li><p>Building the MixME input object</p></li>
<li><p>Running the simulation</p></li>
<li><p>Analysing the results of the simulation</p></li>
<li><p>HCR parameters</p></li>
<li><p>Additions or differences in the shortcut model</p></li>
</ul></li>
<li><p>Calculating the risk</p></li>
<li><p>Parallelisation</p></li>
</ul>
<p>HIGHLIGHT SOMEHWRE ETHAT FTARGETS ARE STAYIING THE SAME THROUGHOUT THE SIMUALTION????? - MIxME simualtion loop says HCR can cause it to vary</p>
<p>“Fishing fleet effort is constant throughout the simulation - a consequence of the linear relationship between effort and fishing mortality.”, ” We can see that the fishing mortality target is constant over time, whilst catch target from each stock varies from year to year.” - Fixed fishing mortality management strategy wiki page</p>
</section>
<section id="context" class="level1">
<h1>Context</h1>
<p>The aim of this half of the project is to apply the methods from the first half of the project to mixed fisheries using the MixME R package. I have used the methods from the first half of the project to write code that follows a very similar process, but where the aim is now to find the Ftarget for each stock that is precautionary but maximises total catch over the years 2030 to 2039. I set this goal because MixME is designed to run projections into the future, and looking at catch in the long term will minimise the chance that a simulation where a stock fails is chosen <span class="citation" data-cites="MixME">(<a href="#ref-MixME" role="doc-biblioref">Pace et al. 2025a</a>)</span>,<span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. The 20 year projection from 2020-2039 was kept consistent with examples on the MixME documentation and follows guidelines from ICES to create long-term projections based on the biology of the stocks <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>,<span class="citation" data-cites="ICES2019WKGMSE2">(<a href="#ref-ICES2019WKGMSE2" role="doc-biblioref">ICES 2019a</a>)</span>. It also follows ICES guidelines to only calculate catch and risk for the last ten years for long-term projection, to allow time for a recovery period <span class="citation" data-cites="ICES2019WKGMSE2">(<a href="#ref-ICES2019WKGMSE2" role="doc-biblioref">ICES 2019a</a>)</span>.</p>
<p>I focused on the datasets from the Fixed fishing mortality management strategy example (<code>mixedfishery_MixME_om</code>) and the Exploring simulation outputs example (<code>mixedfishery_MixME_input</code>) which are both in the MixME documentation <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. However, for the second dataset <code>mixedfishery_MixME_input</code> I was given a shortcut method by a researcher at Cefas which takes a more direct approach to the simulation. The code for these datasets is <code>Optimising_ftarget_in_MixME_mult_points_parallel.R</code> and <code>Two_stocks_Optimising_ftarget_in_shortcut_model.R</code> respectively.</p>
<p>Both of these datasets have two stocks (cod and haddock) and two fleets <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. I was told by the same researcher at Cefas that the stocks are North Sea cod and Celtic Sea haddock, but using citations I can only back up that they are Atlantic cod and haddock <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>,<span class="citation" data-cites="ICESCodFactsheet">(<a href="#ref-ICESCodFactsheet" role="doc-biblioref">ICES, n.d.</a>)</span>,<span class="citation" data-cites="ICESCodFactsheet">(<a href="#ref-ICESCodFactsheet" role="doc-biblioref">ICES, n.d.</a>)</span>. This allows me to use the same methods as in the first half of the project by replacing <span class="math inline">\(F_{target}\)</span> with <span class="math inline">\(F_{cod}\)</span> and <span class="math inline">\(B_{trigger}\)</span> with <span class="math inline">\(F_{had}\)</span>, where <span class="math inline">\(F_{cod}\)</span> and <span class="math inline">\(F_{had}\)</span> are the fishing mortalities for cod and haddock respectively.</p>
<p>For this half of the project, we have switched to modelling SSB directly instead of calculating the risk. This is due to the simulation being deterministic as both datasets only have one iteration and the noise for this is pre-calculated <span class="citation" data-cites="MixMESupp">(<a href="#ref-MixMESupp" role="doc-biblioref">Pace et al. 2025b</a>)</span>. These conditions simplify the simulation but unfortunately mean that we cannot use the standard ICES definition of risk to calculate <span class="math inline">\(Risk = P(SSB &lt; B_{lim})\)</span> <span class="citation" data-cites="MixMESupp">(<a href="#ref-MixMESupp" role="doc-biblioref">Pace et al. 2025b</a>)</span>,<span class="citation" data-cites="ICES2019WKGMSE2">(<a href="#ref-ICES2019WKGMSE2" role="doc-biblioref">ICES 2019a</a>)</span>. Instead, we extract <span class="math inline">\(\textrm{min}(SSB)\)</span> for each sampled point from the years 2030-2039 in the simulation and then model these as a GP <span class="citation" data-cites="Originalpaper">(<a href="#ref-Originalpaper" role="doc-biblioref">Spence 2025</a>)</span>,<span class="citation" data-cites="ICES2019WKGMSE2">(<a href="#ref-ICES2019WKGMSE2" role="doc-biblioref">ICES 2019a</a>)</span>. This allows us to predict the distribution of <span class="math inline">\(\textrm{min}(SSB)\)</span> values at each point in the design space. - FIND CITATION, JUSTIFY For each point, we then see how many of these predicted values fall below <span class="math inline">\(B_{lim}\)</span> to calculate <span class="math inline">\(P(\textrm{min}(SSB) &lt; B_{lim})\)</span> at that point <span class="citation" data-cites="Originalpaper">(<a href="#ref-Originalpaper" role="doc-biblioref">Spence 2025</a>)</span>. We do this for each stock. This method of calculation satisfies the ICES precautionary standard <span class="citation" data-cites="ICES2019WKGMSE2">(<a href="#ref-ICES2019WKGMSE2" role="doc-biblioref">ICES 2019a</a>)</span>.</p>
<p>Due to the change in stocks being modelled, I have decided to keep the GP prior for catch modelled by the <code>~.^2</code> function in R for every round of the optimisation process. Despite the more complicated prior used in later rounds in <code>case_study8.R</code> being designed to approximate yield curves, it may not be appropriate in a mixed fisheries context where the catch of one species is affected by the catch of another <span class="citation" data-cites="Originalpaper">(<a href="#ref-Originalpaper" role="doc-biblioref">Spence 2025</a>)</span>,<span class="citation" data-cites="MixME">(<a href="#ref-MixME" role="doc-biblioref">Pace et al. 2025a</a>)</span>, <span class="citation" data-cites="ULRICH201238">(<a href="#ref-ULRICH201238" role="doc-biblioref">Ulrich et al. 2012</a>)</span>. Leaving the GP more general avoids mis-specification, ensuring that the GP can be appropriately fitted to the points <span class="citation" data-cites="williams2006gaussian">(<a href="#ref-williams2006gaussian" role="doc-biblioref">Williams and Rasmussen 2006</a>)</span>.</p>
<p>The process for the first half of the project adapted to our new situation is outlined below. We take a Bayesian History Matching (BHM) approach <span class="citation" data-cites="Originalpaper">(<a href="#ref-Originalpaper" role="doc-biblioref">Spence 2025</a>)</span>. Firstly, to get some initial data, we randomly sample our first set of <span class="math inline">\(n-1\)</span> points, where <span class="math inline">\(n\)</span> is the number of cores the system we are on has <span class="citation" data-cites="Originalpaper">(<a href="#ref-Originalpaper" role="doc-biblioref">Spence 2025</a>)</span>. Then, for each round we do the following:</p>
<ul>
<li><p>We set up or update the Gaussian Processes (GPs) to model the <span class="math inline">\(\textrm{min}(SSB)\)</span> from 2030-2039 for each stock and the GP to model the total catch from 2030-2039</p></li>
<li><p>We can then use the <span class="math inline">\(B_{lim}\)</span> for each stock as a threshold so that we only consider the values of <span class="math inline">\(F_{cod}\)</span> and <span class="math inline">\(F_{had}\)</span> that have <span class="math inline">\(SSB\)</span> above <span class="math inline">\(B_{lim}\)</span> for all of the last ten years of the simulation (2030-2039)</p></li>
<li><p>We use the GP which is modelling the total catch to predict the value for the total catch at every point in the sample space, which will have some uncertainty</p></li>
<li><p>We use BHM to remove any points that are implausible (that have a probability less than 0.01 of being higher than the current best total catch - DOUBLE CHECK)</p></li>
<li><p>We use the Knowledge Gradient (KG) acquisition function to select <span class="math inline">\(n-1\)</span> plausible points to sample in the next round, as per the discussion in <a href="https://github.com/dtj504-pixel/DissertationWork/blob/main/Deciding%20which%20acquisition%20function%20is%20best.qmd">Deciding which acquisition function is best</a></p></li>
</ul>
<p>We repeat this process until there is only one plausible point left and then we will accept this as being the <span class="math inline">\(F_{cod}\)</span> and <span class="math inline">\(F_{had}\)</span> that maximise the catch whilst keeping the <span class="math inline">\(SSB\)</span> above <span class="math inline">\(B_{lim}\)</span>.</p>
<section id="calculating-the-risk" class="level2">
<h2 class="anchored" data-anchor-id="calculating-the-risk">Calculating the risk</h2>
<p>NOTE THIS IS DIFFERENT OT MIXME WAY BUT MROE INFORMATIVE AND MEETS ICES STANDARD, UNLIKE MIXME WAY</p>
<p>In contrast to the first half of the project, we now calculate the risk using the <span class="math inline">\(SSB\)</span>. We have described it above briefly but will go into more detail here.</p>
<p>We should quickly note before our calculations that our new sample space is as below:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Sample Space as discrete with 0.02 increments</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">expand.grid</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Fcod =</span> <span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fl">0.6</span>, <span class="at">by=</span><span class="fl">0.02</span>),</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Fhad =</span> <span class="fu">seq</span>(<span class="fl">0.0</span>, <span class="fl">0.6</span>, <span class="at">by=</span><span class="fl">0.02</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This range ensures that we are able to model stock collapse for cod by modelling values above <span class="math inline">\(F_{lim}\)</span> and that we can model stock recovery for cod by including very low values <span class="citation" data-cites="ICES2019CodAdvice">(<a href="#ref-ICES2019CodAdvice" role="doc-biblioref">ICES 2019c</a>)</span>. It also allows us to model unsafe fishing for haddock by modelling values above <span class="math inline">\(F_{MSY}\)</span> <span class="citation" data-cites="ICES2019HaddockAdvice">(<a href="#ref-ICES2019HaddockAdvice" role="doc-biblioref">ICES 2019b</a>)</span>. Recalling that cod is the choke stock for both of our datasets, this sample space is appropriate <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<p>We also have a <span class="math inline">\(B_{lim}\)</span> for each stock, taken from ICES advice <span class="citation" data-cites="ICES2020HaddockBlim">(<a href="#ref-ICES2020HaddockBlim" role="doc-biblioref">ICES 2020b</a>)</span>,<span class="citation" data-cites="ICES2020CodBlim">(<a href="#ref-ICES2020CodBlim" role="doc-biblioref">ICES 2020a</a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>Blim_cod <span class="ot">&lt;-</span> <span class="dv">107000</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>Blim_had <span class="ot">&lt;-</span> <span class="dv">9227</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Firstly, we extract the <span class="math inline">\(\textrm{min}(SSB)\)</span> for each stock from the result of the simulation we have run using the tracking object <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>,<span class="citation" data-cites="MixME">(<a href="#ref-MixME" role="doc-biblioref">Pace et al. 2025a</a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## // Extract the min ssb at the last ten years of the simulation for both stocks //</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Picking up long term SSB values to see if they dip below Blim at any point</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    ssb_cod_data <span class="ot">&lt;-</span> <span class="fu">c</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>cod<span class="sc">$</span>stk[<span class="st">"SB.om"</span>, <span class="fu">ac</span>(<span class="dv">2030</span><span class="sc">:</span><span class="dv">2039</span>)])</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    ssb_had_data <span class="ot">&lt;-</span> <span class="fu">c</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>had<span class="sc">$</span>stk[<span class="st">"SB.om"</span>, <span class="fu">ac</span>(<span class="dv">2030</span><span class="sc">:</span><span class="dv">2039</span>)])</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Getting minimum ssb during this time for each stock to model with GPs</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    ssb_cod_min <span class="ot">&lt;-</span> <span class="fu">min</span>(ssb_cod_data, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    ssb_had_min <span class="ot">&lt;-</span> <span class="fu">min</span>(ssb_had_data, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We then put these results into the GP we will use to model <span class="math inline">\(\textrm{min}(SSB)\)</span> for each stock:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>gp_cod_ssb <span class="ot">&lt;-</span> <span class="fu">km</span>(<span class="sc">~</span>.<span class="sc">^</span><span class="dv">2</span>,<span class="at">design=</span>runs[,<span class="fu">c</span>(<span class="st">"Fcod"</span>,<span class="st">"Fhad"</span>)],<span class="at">estim.method=</span><span class="st">"MLE"</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">response =</span> ssb_cod_min,<span class="at">nugget=</span><span class="fl">1e-12</span><span class="sc">*</span><span class="fu">var</span>(ssb_cod_min)<span class="sc">+</span><span class="fl">1e-15</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">covtype =</span> <span class="st">"exp"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>gp_had_ssb <span class="ot">&lt;-</span> <span class="fu">km</span>(<span class="sc">~</span>.<span class="sc">^</span><span class="dv">2</span>,<span class="at">design=</span>runs[,<span class="fu">c</span>(<span class="st">"Fcod"</span>,<span class="st">"Fhad"</span>)],<span class="at">estim.method=</span><span class="st">"MLE"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">response =</span> ssb_had_min,<span class="at">nugget=</span><span class="fl">1e-12</span><span class="sc">*</span><span class="fu">var</span>(ssb_had_min)<span class="sc">+</span><span class="fl">1e-15</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">covtype =</span> <span class="st">"exp"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>These GPs have remained modelled by the <code>.^2</code> function, the same as in the GP for risk in the first half of the project, as this is quite general and avoids mis-specification <span class="citation" data-cites="williams2006gaussian">(<a href="#ref-williams2006gaussian" role="doc-biblioref">Williams and Rasmussen 2006</a>)</span>,<span class="citation" data-cites="DiceKrigingPaper">(<a href="#ref-DiceKrigingPaper" role="doc-biblioref">Roustant, Ginsbourger, and Deville 2012</a>)</span>. They have also kept the same estimation method, nugget and kernel <span class="citation" data-cites="williams2006gaussian">(<a href="#ref-williams2006gaussian" role="doc-biblioref">Williams and Rasmussen 2006</a>)</span>. - JUSTIFY</p>
<p>Next, we predict the <span class="math inline">\(\textrm{min}(SSB)\)</span> for every point in the sample space:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pred_ssb_cod <span class="ot">&lt;-</span> <span class="fu">predict</span>(gp_cod_ssb, <span class="at">newdata =</span> dat, <span class="at">type =</span> <span class="st">"SK"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>pred_ssb_had <span class="ot">&lt;-</span> <span class="fu">predict</span>(gp_had_ssb, <span class="at">newdata =</span> dat, <span class="at">type =</span> <span class="st">"SK"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We then calculate <span class="math inline">\(Risk = P(SSB &lt; B_{lim})\)</span> for each stock:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the probability that sbb =&lt; Blim for cod and haddock</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>pssb_cod <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Blim_cod, pred_ssb_cod<span class="sc">$</span>mean, pred_ssb_cod<span class="sc">$</span>sd <span class="sc">+</span> <span class="fl">1e-12</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>pssb_had <span class="ot">&lt;-</span> <span class="fu">pnorm</span>(Blim_had, pred_ssb_had<span class="sc">$</span>mean, pred_ssb_had<span class="sc">$</span>sd <span class="sc">+</span> <span class="fl">1e-12</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then, we set the KG of any unsafe points to be zero so that they will not be chosen as points to be sampled in the future:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop over candidate points</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(m)) {</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set to 0 for any unsafe points - any points with </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># probability that ssb &lt; Blim &gt; 0.05 in the years 2030-2039 </span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># i.e. the run is not precautionary in these years</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (pssb_cod[i] <span class="sc">&gt;</span> <span class="fl">0.05</span> <span class="sc">||</span> pssb_had[i] <span class="sc">&gt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      kg[i] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can say <code>ssb &lt; Blim</code> here instead of <code>ssb =&lt; Blim</code> because we are sampling from a continuous normal distribution and so they are equivalent.</p>
<p>By ensuring that <span class="math inline">\(P(\textrm{min}(SSB) &lt; B_{lim}) &lt; 0.05\)</span> we ensure that <span class="math inline">\(P(SSB &lt; B_{lim})&lt;0.05\)</span> for every year in the long term forecast (2030-2039). This guarantees that the maximum annual risk in this period remains below the 5% threshold, which is exactly what is required to meet the ICES precautionary standard due to their definition of <span class="math inline">\(Prob3\)</span> in <span class="citation" data-cites="ICES2019WKGMSE2">(<a href="#ref-ICES2019WKGMSE2" role="doc-biblioref">ICES 2019a</a>)</span>. This means that this risk calculation could be used in policy documents to set official catch limits in countries that have agreed to this standard <span class="citation" data-cites="ICES2019WKGMSE2">(<a href="#ref-ICES2019WKGMSE2" role="doc-biblioref">ICES 2019a</a>)</span>.</p>
</section>
<section id="the-basics-of-the-mixme-model" class="level2">
<h2 class="anchored" data-anchor-id="the-basics-of-the-mixme-model">The basics of the MixME model</h2>
<p>Going to write down everything and then remove areas Gustav said I don’t need to worry about.</p>
<ul>
<li>Explaining the tracking object as this how I get catch ?? - MAYBE IN A SECTION SUMMARISING FULL CODE PROPCESS?</li>
</ul>
<section id="starting-f_cod-and-f_had" class="level3">
<h3 class="anchored" data-anchor-id="starting-f_cod-and-f_had">Starting <span class="math inline">\(F_{cod}\)</span> and <span class="math inline">\(F_{had}\)</span></h3>
<p>We started with <span class="math inline">\(F_{cod} = 0.28\)</span> and <span class="math inline">\(F_{had} = 0.353\)</span> based upon the values given in the Fixed fishing mortality management strategy example from the MixME wiki <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. These were drawn from the North Seas Cod and Celtic Seas Haddock advice published in 2020 respectively <span class="citation" data-cites="ICES2021Cod028">(<a href="#ref-ICES2021Cod028" role="doc-biblioref">ICES 2021</a>)</span>,<span class="citation" data-cites="ICES2020HaddockBlim">(<a href="#ref-ICES2020HaddockBlim" role="doc-biblioref">ICES 2020b</a>)</span>.</p>
</section>
<section id="creating-the-operating-model" class="level3">
<h3 class="anchored" data-anchor-id="creating-the-operating-model">Creating the Operating model</h3>
<p>We first create the operating model <code>mixedfishery_MixME_om</code> which contains the true data for the stocks and fleets in the dataset <span class="citation" data-cites="MixME">(<a href="#ref-MixME" role="doc-biblioref">Pace et al. 2025a</a>)</span>. We have data for North Sea Cod from 1963-2019 and form Celtic Sea Haddock from 1993-2019 <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. For the stocks, this includes the numbers, natural mortality, stock mean individual weight and proportion mature split by age and for fleets this includes landing numbers, landing mean individual weight, discard numbers, discard mean individual weight, selectivity and catchability <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span><strong>. - DISCUSS CATCHABILITY?</strong></p>
<p>In both of our files, this is loaded with the dataset <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. This true data is generated using standard age-structured equations to model the dynamics of the fleets and the stocks <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. For every year, it has the catch (in terms of landings and discards) from each fleet and the survivors from that year <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. It also contains a stock-recruitment model and recruitment is done at the beginning of each time step <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<p>The steps for fully assembling the operating model for input into the MixME model are:</p>
<ol type="1">
<li><p>Estimate historic quota-share for the two fleets</p></li>
<li><p>Project stock n years into the future</p></li>
<li><p>Calculate numbers of both stocks in initial year</p></li>
<li><p>Generate an observation error model</p></li>
</ol>
<section id="estimate-historic-quota-share-for-the-two-fleets" class="level4">
<h4 class="anchored" data-anchor-id="estimate-historic-quota-share-for-the-two-fleets">Estimate historic quota-share for the two fleets</h4>
<p>Firstly, we use <code>mixedfishery_MixME_om</code> to determine the quota share of the catch for each fleet. This is done by assuming for each stock that the quota share corresponds to the proportional share of landings and is carried out by the <code>calculateQuotashare</code> function <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">calculateQuotashare</span>(<span class="at">stks =</span> mixedfishery_MixME_om<span class="sc">$</span>stks, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">flts =</span> mixedfishery_MixME_om<span class="sc">$</span>flts, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>IS THIS IT?</p>
</section>
<section id="project-stock-n-years-into-the-future" class="level4">
<h4 class="anchored" data-anchor-id="project-stock-n-years-into-the-future">Project stock n years into the future</h4>
<p>To carry out our 20 year projection, we need to extend the stock and fishery structures forward from 2019 into 2039. There are three categories of parameters that are not estimated dynamically and so need to be extended <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. These are:</p>
<ol type="1">
<li><p>All stock parameters, landings and discards mean individual weights and landed fraction</p></li>
<li><p>Catchability and catch selection</p></li>
<li><p>Quota-share</p></li>
</ol>
<p>We project the parameters in each of these categories from 2019-2039 using the average from the last three years using the <code>stfMixME</code> function <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">stfMixME</span>(mixedfishery_MixME_om, <span class="at">method =</span> <span class="st">"yearMeans"</span>, <span class="at">nyears =</span> <span class="dv">20</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">wts.nyears =</span> <span class="dv">3</span>, <span class="at">sel.nyears =</span> <span class="dv">3</span>, <span class="at">qs.nyears =</span> <span class="dv">3</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="calculate-numbers-of-both-stocks-in-initial-year" class="level4">
<h4 class="anchored" data-anchor-id="calculate-numbers-of-both-stocks-in-initial-year">Calculate numbers of both stocks in initial year</h4>
<p>To be able to do our projections of catch, we need to know the number of each stock in each age class at the beginning of the first projection year, 2020. This requires us to do a 1-year short term forecast from our starting point of 2019 using the FLasher package <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># initial projection year</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>iy <span class="ot">=</span> <span class="dv">2020</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># set an arbitrary effort-based target for each fleet as we only want the</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># values at the beginning of 2020</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ctrlArgs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(mixedfishery_MixME_om<span class="sc">$</span>flts), <span class="cf">function</span>(x) {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">list</span>(<span class="at">year =</span> iy,<span class="at">quant =</span> <span class="st">"effort"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">fishery =</span> <span class="fu">names</span>(mixedfishery_MixME_om<span class="sc">$</span>flts)[x],<span class="at">value =</span> <span class="dv">1</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># This matrix maps which fleets catch which stocks</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>ctrlArgs<span class="sc">$</span>FCB <span class="ot">&lt;-</span> <span class="fu">makeFCB</span>(<span class="at">biols =</span> mixedfishery_MixME_om<span class="sc">$</span>stks,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">flts =</span> mixedfishery_MixME_om<span class="sc">$</span>flts)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate effort-based FLasher::fwd forecast control</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>flasher_ctrl <span class="ot">&lt;-</span> <span class="fu">do.call</span>(FLasher<span class="sc">::</span>fwdControl, ctrlArgs)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate one year of fishing to get starting conditions right</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>omfwd <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">fwd</span>(<span class="at">object =</span> mixedfishery_MixME_om<span class="sc">$</span>stks,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">fishery =</span> mixedfishery_MixME_om<span class="sc">$</span>flts,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">control =</span> flasher_ctrl)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Update the operating model with projected population numbers</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>mixedfishery_MixME_om<span class="sc">$</span>stks<span class="sc">$</span>had<span class="sc">@</span>n[,<span class="fu">ac</span>(iy)] <span class="ot">&lt;-</span> omfwd<span class="sc">$</span>biols<span class="sc">$</span>had<span class="sc">@</span>n[,<span class="fu">ac</span>(iy)]</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>mixedfishery_MixME_om<span class="sc">$</span>stks<span class="sc">$</span>cod<span class="sc">@</span>n[,<span class="fu">ac</span>(iy)] <span class="ot">&lt;-</span> omfwd<span class="sc">$</span>biols<span class="sc">$</span>cod<span class="sc">@</span>n[,<span class="fu">ac</span>(iy)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We set an arbitrary forecast target here because the 2020 numbers are calculated from existing numbers (rather than a defined target) <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. - ? FIND OUT MORE</p>
</section>
<section id="creating-the-observation-error-model" class="level4">
<h4 class="anchored" data-anchor-id="creating-the-observation-error-model">Creating the Observation Error Model</h4>
<p>This is another important component of the MixME model <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. We create the observation error model <code>stk_oem</code> where we apply pre-sampled noise to the catch from each fleet (which we obtained earlier from the <code>mixedfishery_MixME_om</code> object) <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. We generate future stock and management advice from this object <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. - MAY NEED TO REFERENCE MORE COMPLICATED TUTORIAL FOR FULL EXPLANATION OF THIS</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of FLStock objects from the FLBiol objects in </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the operating model</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>stk_oem <span class="ot">&lt;-</span> <span class="fu">FLStocks</span>(<span class="fu">lapply</span>(mixedfishery_MixME_om<span class="sc">$</span>stks, <span class="cf">function</span>(x) {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for each fleet, find which catch element corresponds </span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># to the current stock</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  catch <span class="ot">&lt;-</span> <span class="fu">sapply</span>(mixedfishery_MixME_om<span class="sc">$</span>flts, <span class="cf">function</span>(y) </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>           <span class="fu">which</span>(<span class="fu">names</span>(y) <span class="sc">%in%</span> <span class="fu">name</span>(x)))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get catches form each fleet and convert to FLStock</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  xx <span class="ot">&lt;-</span> <span class="fu">as.FLStock</span>(x, mixedfishery_MixME_om<span class="sc">$</span>flts, </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">full =</span> <span class="cn">FALSE</span>, <span class="at">catch =</span> catch)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># specifies fishing mortality is measured as instantaneous </span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fishing mortality rate</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">units</span>(xx<span class="sc">@</span>harvest) <span class="ot">&lt;-</span> <span class="st">"f"</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove excess data as we don't observe stock biomass or stock </span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># numbers-at-age directly in reality forces us to simulate </span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># these using only the available data</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stock.n</span>(xx)[] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stock</span>(xx)[]   <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return the converted object</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(xx)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="build-the-mixme-input-object" class="level3">
<h3 class="anchored" data-anchor-id="build-the-mixme-input-object">Build the MixME input object</h3>
<p>We then use this in the <code>makeMixME</code> function to make the MixME input object, which can then be used to run the simulation. We have five arguments here. Two of these are where we input our Operating Model and our Observation Error model. The next two specify how many time steps (in our scenario, years) it takes for the management advice to be enacted and what type of management we are using respectively <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. The last argument - NOT DESCRIBED YET</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>  input <span class="ot">&lt;-</span> <span class="fu">makeMixME</span>(<span class="at">om =</span> mixedfishery_MixME_om, <span class="at">catch_obs =</span> stk_oem,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">management_lag =</span> <span class="dv">0</span>, <span class="at">management_type =</span> <span class="st">"fixedF"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">parallel =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="running-the-simulation" class="level3">
<h3 class="anchored" data-anchor-id="running-the-simulation">Running the simulation</h3>
<p>We update some of the management and simulation settings and then run the simulation <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cod and haddock catches occur at the start of the year so timing=0</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>oem<span class="sc">@</span>args<span class="sc">$</span>catch_timing<span class="sc">$</span>cod <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>oem<span class="sc">@</span>args<span class="sc">$</span>catch_timing<span class="sc">$</span>had <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the age range for calculating average fishing mortality </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># (Fbar) for both stocks</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>oem<span class="sc">@</span>observations<span class="sc">$</span>stk<span class="sc">$</span>cod<span class="sc">@</span>range[<span class="fu">c</span>(<span class="st">"minfbar"</span>,<span class="st">"maxfbar"</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">4</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>oem<span class="sc">@</span>observations<span class="sc">$</span>stk<span class="sc">$</span>had<span class="sc">@</span>range[<span class="fu">c</span>(<span class="st">"minfbar"</span>,<span class="st">"maxfbar"</span>)] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">5</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the target fishing mortality for both stocks as </span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># the next point decided by the algorithm</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>ctrl_obj<span class="sc">$</span>hcr<span class="sc">@</span>args<span class="sc">$</span>ftrg<span class="sc">$</span>cod <span class="ot">&lt;-</span> f_cod</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>ctrl_obj<span class="sc">$</span>hcr<span class="sc">@</span>args<span class="sc">$</span>ftrg<span class="sc">$</span>had <span class="ot">&lt;-</span> f_had</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Update fbar ranges</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>args<span class="sc">$</span>frange<span class="sc">$</span>cod <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"minfbar"</span> <span class="ot">=</span> <span class="dv">2</span>, <span class="st">"maxfbar"</span> <span class="ot">=</span> <span class="dv">4</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>args<span class="sc">$</span>frange<span class="sc">$</span>had <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"minfbar"</span> <span class="ot">=</span> <span class="dv">3</span>, <span class="st">"maxfbar"</span> <span class="ot">=</span> <span class="dv">5</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">#RUN MIXME SIMULATION</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">runMixME</span>(<span class="at">om  =</span> input<span class="sc">$</span>om, <span class="at">oem =</span> input<span class="sc">$</span>oem, </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">ctrl_obj =</span> input<span class="sc">$</span>ctrl_obj, <span class="at">args =</span> input<span class="sc">$</span>args)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>It can be seen above that we have updated the arguments for when catches occur, the age range for calculating average fishing mortality in all the places it is needed and the target fishing mortality we are using for this round of the simulation <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
</section>
<section id="analysing-results-of-the-simulation" class="level3">
<h3 class="anchored" data-anchor-id="analysing-results-of-the-simulation">Analysing results of the simulation</h3>
<p>The <code>tracking</code> object records summary statistics for the modelled stock and fleet dynamics, as well as metrics describing the observed state of the system by the management procedure. It also contains simulation performance and diagnostics statistics, which is what we will focus on here <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<p>We firstly check for management advice failure <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check for advice failure</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>iterfail, <span class="dv">1</span>, mean)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then we can also check for effort optimisation failure and the message given if there was any failure <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check for effort optimisation failure</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>tracking<span class="sc">$</span>optim</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Check for effort optimisation message</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>tracking<span class="sc">$</span>message</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Effort optimisation failure can be sued to see if we are over-fishing the stocks to a point that they will go extinct <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<p>Another result we can see is the over-quota catches <span class="citation" data-cites="mixMEwiki">(<a href="#ref-mixMEwiki" role="doc-biblioref"><strong>mixMEwiki?</strong></a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check maximum overshoot of the quota by fleets</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">max</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>overquota, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can also check the quota uptake using the below <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check quota uptake for cod and haddock</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>tracking<span class="sc">$</span>uptake[<span class="st">"cod"</span>,,,<span class="dv">1</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>tracking<span class="sc">$</span>uptake[<span class="st">"had"</span>,,,<span class="dv">1</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Lastly, we can check which stock is the choke stock using <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Check choke stock</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>tracking<span class="sc">$</span>choke</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="hcr-parameters" class="level3">
<h3 class="anchored" data-anchor-id="hcr-parameters">HCR parameters</h3>
<p>We add <span class="math inline">\(B_{lim}\)</span> into the HCR to help us calculate the risk later on <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>. It is helpful for calculating it in our current way, or the way MixME defines it as: “the proportion of iterations (read replicates) in each year where stock spawning biomass falls below the biological limit reference point (<span class="math inline">\(B_{lim}\)</span>)” <span class="citation" data-cites="MixMEwiki">(<a href="#ref-MixMEwiki" role="doc-biblioref">Pace 2024</a>)</span>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Define Blim for each stock - required for way </span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">#calculating risk right now</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>hcrpars <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">cod =</span> <span class="fu">c</span>(<span class="at">Blim =</span> <span class="dv">107000</span>), <span class="at">had =</span> <span class="fu">c</span>(<span class="at">Blim =</span> <span class="dv">9227</span>))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Update the control object with the new HCR parameters</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>ctrl_obj<span class="sc">$</span>phcr <span class="ot">&lt;-</span> <span class="fu">mseCtrl</span>(<span class="at">args =</span> <span class="fu">list</span>(<span class="at">hcrpars =</span> hcrpars))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>ARE THERE OTHER hcrpars ALREADY DEFINED?</p>
</section>
<section id="additions-or-differences-in-the-shortcut-model" class="level3">
<h3 class="anchored" data-anchor-id="additions-or-differences-in-the-shortcut-model">Additions or Differences in the Shortcut Model</h3>
<p>NEED CITATIONS FROM SOMEWHERE BUT MAY BE VERY DIFFICULT AS NOT PUBLIC YET</p>
<p>This is the <code>Two_stocks_Optimising_ftarget_in_shortcut_model.R</code> file. We use the same data here as in the <code>Optimising_ftarget_in_MixME_mult_points_parallel.R</code> file, except that we have now also loaded in the Operating Model and Observation Error Model with the data <span class="citation" data-cites="MixMewiki">(<a href="#ref-MixMewiki" role="doc-biblioref"><strong>MixMewiki?</strong></a>)</span>.</p>
<section id="zero-catch-advice" class="level4">
<h4 class="anchored" data-anchor-id="zero-catch-advice">Zero-catch advice</h4>
<p>CHECK DEFINETLY NOT IN OLD METHOD</p>
<p>In this simulation, we have a condition meaning we return zero-catch advice if the <span class="math inline">\(SSB\)</span> is below <span class="math inline">\(B_{lim}\)</span> in the year after the advice year. We are checking the year after the advice year due to our management lag of one year. Firstly, we identify any simulation where <span class="math inline">\(SSB &lt;B_{lim}\)</span> and re-run these simulations specifically targeting <span class="math inline">\(B_{lim}\)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Find iterations where SSB at end of TAC year is &lt; Blim</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  belowBlim <span class="ot">&lt;-</span> <span class="fu">which</span>(TACyr_ssb <span class="sc">&lt;</span> <span class="fu">attr</span>(ctrl, <span class="st">"Blim"</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Go through model fits - where SSB &lt; Blim, forecast to target Blim</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(belowBlim) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## define forward control targetting Blim</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    targ <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span>fwd_yrs<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> niter)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fsq</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># target is now Blim</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">attr</span>(ctrl,<span class="st">"Blim"</span>))</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">3</span>,] <span class="ot">&lt;-</span> ctrl<span class="sc">@</span>iters[,<span class="st">"value"</span>,]</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    ctrl_blim <span class="ot">&lt;-</span> <span class="fu">fwdControl</span>(<span class="fu">list</span>(</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">year  =</span> <span class="fu">c</span>(ay,ay<span class="sc">+</span>mlag,ay<span class="sc">+</span>mlag<span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">#focus on biomass in the 2nd year to force us to end at</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Blim instead if we were below</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant =</span> <span class="fu">c</span>(<span class="st">"fbar"</span>,<span class="st">"ssb_end"</span>,<span class="st">"fbar"</span>),</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> <span class="fu">c</span>(targ)))</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#rerun simulation focusing on Blim to find the Ftarget</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that is appropriate</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    stk_blim <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">fwd</span>(stk0, <span class="at">sr =</span> sr0, <span class="at">control =</span> ctrl_blim)<span class="co">#</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>However, if this still fails, we identify these runs in the <code>zeroTAC</code> variable and manually set the total annual catch (TAC) to zero.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Find iterations with zero TAC advice </span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (some stocks may be in such bad health that we can't catch any)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>zeroTAC <span class="ot">&lt;-</span> <span class="fu">ssb</span>(stk_blim)[,<span class="fu">ac</span>(ay<span class="sc">+</span>mlag<span class="sc">+</span><span class="dv">1</span>)] <span class="sc">&lt;</span> <span class="fu">attr</span>(ctrl,<span class="st">"Blim"</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co"># set any in zeroTAC to zero manually</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>TAC[zeroTAC]   <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Combined, this looks like:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Find iterations where SSB at end of TAC year is &lt; Blim</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>belowBlim <span class="ot">&lt;-</span> <span class="fu">which</span>(TACyr_ssb <span class="sc">&lt;</span> <span class="fu">attr</span>(ctrl, <span class="st">"Blim"</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Go through model fits - where SSB &lt; Blim, forecast to target Blim</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(belowBlim) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## define forward control targetting Blim</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    targ <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span>fwd_yrs<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> niter)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fsq</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># target is now Blim</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">attr</span>(ctrl,<span class="st">"Blim"</span>))</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">3</span>,] <span class="ot">&lt;-</span> ctrl<span class="sc">@</span>iters[,<span class="st">"value"</span>,]</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    ctrl_blim <span class="ot">&lt;-</span> <span class="fu">fwdControl</span>(<span class="fu">list</span>(</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">year  =</span> <span class="fu">c</span>(ay,ay<span class="sc">+</span>mlag,ay<span class="sc">+</span>mlag<span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">#focus on biomass in the 2nd year to force us to end at </span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Blim instead if we were below</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant =</span> <span class="fu">c</span>(<span class="st">"fbar"</span>,<span class="st">"ssb_end"</span>,<span class="st">"fbar"</span>),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> <span class="fu">c</span>(targ)))</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#rerun simulation focusing on Blim to find the Ftarget </span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that is appropriate</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    stk_blim <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">fwd</span>(stk0, <span class="at">sr =</span> sr0, <span class="at">control =</span> ctrl_blim)</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Find iterations with zero TAC advice </span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (some stocks may be in such bad health that we can't catch any)</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    zeroTAC <span class="ot">&lt;-</span> <span class="fu">ssb</span>(stk_blim)[,<span class="fu">ac</span>(ay<span class="sc">+</span>mlag<span class="sc">+</span><span class="dv">1</span>)] <span class="sc">&lt;</span> <span class="fu">attr</span>(ctrl,<span class="st">"Blim"</span>)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="do">## update TAC</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    TAC[belowBlim] <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">catch</span>(stk_blim)[,<span class="fu">ac</span>(ay<span class="sc">+</span>mlag)])[belowBlim],<span class="dv">3</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set any in zeroTAC to zero manually</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    TAC[zeroTAC]   <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="ices_hcr-function" class="level4">
<h4 class="anchored" data-anchor-id="ices_hcr-function"><code>ICES_HCR</code> function</h4>
<p>This is a new way to create the HCR.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## === Define a custom harvest control rule ===</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ICES_HCR <span class="ot">&lt;-</span> <span class="cf">function</span> (stk, args, hcrpars, tracking) {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param stk contains information about fish stocks, e.g. age</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param args contains useful arguments such as ay and mlag</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param hcrpars contains the parameters of the HCR, e.g. Ftrgt, Btrigger, Blim</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tracking contains the current tracking object and </span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># is currently returned unchanged</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extract year arguments</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ay is the current assessment year</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  ay <span class="ot">&lt;-</span> args<span class="sc">$</span>ay</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># mlag is the management lag in years</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  mlag <span class="ot">&lt;-</span> args<span class="sc">$</span>management_lag</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># this is the number of iterations</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  ni <span class="ot">&lt;-</span> <span class="fu">dims</span>(stk)[[<span class="st">"iter"</span>]]</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SHORT-TERM FORECAST</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Carry out short-term forecast to get ssb at the beginning of the advice year</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">## historical geomean to estimate recruitment for the stock </span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># (prevents big spikes in recruitment having a large effect)</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  sr0 <span class="ot">&lt;-</span> <span class="fu">as.FLSR</span>(stk, <span class="at">model =</span> <span class="st">"geomean"</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># propagate sr0 params to match number of simulations</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  sr0<span class="sc">@</span>params <span class="ot">&lt;-</span> FLCore<span class="sc">::</span><span class="fu">propagate</span>(sr0<span class="sc">@</span>params, <span class="at">iter =</span> ni)</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># hardcoded using different starting years for different stocks </span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># when estimating recruitment</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(stk<span class="sc">@</span>name <span class="sc">==</span> <span class="st">"cod"</span>) stk_n <span class="ot">&lt;-</span> <span class="fu">window</span>(stk<span class="sc">@</span>stock.n, <span class="at">start =</span> <span class="dv">2015</span>)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(stk<span class="sc">@</span>name <span class="sc">==</span> <span class="st">"had"</span>) stk_n <span class="ot">&lt;-</span> <span class="fu">window</span>(stk<span class="sc">@</span>stock.n, <span class="at">start =</span> <span class="dv">1993</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We get the row of data for the youngest fish and calculate </span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the geometric mean for that row</span></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We do this by taking a log before calculating the average, </span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as this reduces the effect of large values, </span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and then exponentiating</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  sr0<span class="sc">@</span>params[] <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">yearMeans</span>(<span class="fu">log</span>(stk_n[<span class="dv">1</span>,])))</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">## find the first year with any data</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>  minyr <span class="ot">&lt;-</span> <span class="fu">dims</span>(stk<span class="sc">@</span>stock[<span class="sc">!</span><span class="fu">is.na</span>(stk<span class="sc">@</span>stock.n)])<span class="sc">$</span>minyear</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  <span class="do">## remove any years before this</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  stk0  <span class="ot">&lt;-</span> <span class="fu">window</span>(stk, <span class="at">start =</span> minyr)</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extend stock object by one year</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>  <span class="do">## automatically fills in parameters by averaging over the last 3 years</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>  stk0 <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">stf</span>(stk0, <span class="dv">1</span>)</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FLasher::fwd will throw an error if there are NAs in weights in future years.</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I need to zero these if associated numbers are zero</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>  FLCore<span class="sc">::</span><span class="fu">discards.wt</span>(stk0)[FLCore<span class="sc">::</span><span class="fu">discards.n</span>(stk0) <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>  FLCore<span class="sc">::</span><span class="fu">landings.wt</span>(stk0)[FLCore<span class="sc">::</span><span class="fu">landings.n</span>(stk0) <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  <span class="do">## find status quo F slightly differently for each stock</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cod and whiting average last three years, haddock average last year only</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(stk<span class="sc">@</span>name <span class="sc">==</span> <span class="st">"cod"</span>) fwd_yrs_fsq <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">0</span></span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(stk<span class="sc">@</span>name <span class="sc">==</span> <span class="st">"had"</span>) fwd_yrs_fsq <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># estimated fishing mortality for the forward year for each stock</span></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>  fsq <span class="ot">&lt;-</span> <span class="fu">yearMeans</span>(<span class="fu">fbar</span>(stk)[,<span class="fu">as.character</span>(fwd_yrs_fsq<span class="sc">+</span>ay<span class="sc">-</span>mlag)])</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>  <span class="do">## FLasher cannot handle fsq=0</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>  fsq <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(fsq<span class="sc">==</span><span class="dv">0</span>, <span class="fl">0.001</span>,fsq)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Construct forward fishing mortality with same number of rows as simulations</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Will overwrite the second row later</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>  targ <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span><span class="dv">2</span>, <span class="at">ncol =</span> ni)</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>  targ[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fsq</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>  targ[<span class="dv">2</span>,] <span class="ot">&lt;-</span> fsq</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Wrappper that constructs the fwdControl object, setting fbar </span></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># to values in the targ matrix</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>  ctrl0 <span class="ot">&lt;-</span> <span class="fu">fwdControl</span>(<span class="fu">list</span>(</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">year  =</span> <span class="fu">c</span>(ay,ay<span class="sc">+</span>mlag),</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">quant =</span> <span class="st">"fbar"</span>,</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">c</span>(targ)))</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>  <span class="do">## project stock forward to get ssb in the advice year</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>  stk_fwd <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">fwd</span>(stk0, <span class="at">sr =</span> sr0, <span class="at">control =</span> ctrl0)</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># HCR</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extract the parameters and propogate to each simulation</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>  Ftrgt <span class="ot">&lt;-</span> <span class="fu">propagate</span>(<span class="fu">FLPar</span>(hcrpars[<span class="st">"Ftrgt"</span>]), ni)</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>  Btrigger <span class="ot">&lt;-</span> <span class="fu">propagate</span>(<span class="fu">FLPar</span>(hcrpars[<span class="st">"Btrigger"</span>]), ni)</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The Blims we put into hcrpars are propagated here </span></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>  Blim <span class="ot">&lt;-</span> <span class="fu">propagate</span>(<span class="fu">FLPar</span>(hcrpars[<span class="st">"Blim"</span>]), ni)</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate F multiplier</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate what ratio of Btrigger we are at for each simulation </span></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - 1 means we're at Btrigger </span></span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>  status_Btrigger <span class="ot">&lt;-</span> <span class="fu">tail</span>(<span class="fu">ssb</span>(stk_fwd), <span class="dv">1</span>)<span class="sc">/</span>Btrigger</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>  <span class="co"># find which simulations are above Btrigger</span></span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>  pos_Btrigger <span class="ot">&lt;-</span> <span class="fu">which</span>(status_Btrigger <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set Ftarget to the ratio of Ftarget that corresponds to status_Btrigger</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>  Fmult <span class="ot">&lt;-</span> status_Btrigger</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cap this ratio at 1</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>  Fmult[, , , , , pos_Btrigger] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate new F target</span></span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>  Ftrgt <span class="ot">&lt;-</span> Ftrgt <span class="sc">*</span> Fmult</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make most of the control object for output</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>  ctrl <span class="ot">&lt;-</span> <span class="fu">fwdControl</span>(<span class="fu">list</span>(<span class="at">year =</span> ay <span class="sc">+</span> mlag, <span class="at">quant =</span> <span class="st">"fbar"</span>, <span class="at">value =</span> Ftrgt))</span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Attach Blim for use in implementation</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(ctrl, <span class="st">"Blim"</span>) <span class="ot">&lt;-</span> Blim</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a>  <span class="co">#return the control object and tracking object</span></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">ctrl =</span> ctrl, <span class="at">tracking =</span> tracking))</span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="forecast_fun-function" class="level4">
<h4 class="anchored" data-anchor-id="forecast_fun-function"><code>forecast_fun</code> function</h4>
<p>This function projects forwards into the next year to set an appropriate TAC. We call this for every year of the simulation and it is similar to the short term forecast we used in the last file.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Advice implementation using FLasher</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' Carry out a short-term forecast using Flasher</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' to transform advised fishing mortality into an advised catch target.</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param stk Object of class \code{FLStock} containing observed stock </span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">#'            information including commercial catch data, individual mean </span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'            weights and biological parameters.</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param tracking Tracking object</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param args Additional arguments</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param forecast Logical. Should a short-term forecast be carried out? Defaults</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'                 to \code{TRUE}</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fwd_trgt Character. Catch or effort target to use during forecast. </span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'                 Defaults to 'fsq'.</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fwd_yrs Integer. The number of years to forecast. Defaults to 1.</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fwd_yrs_average Integer vector. The historical data years over which</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co">#'                        biological parameter are averaged for use during </span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co">#'                        forecast. Defaults to -3:-1.</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fwd_yrs_rec_start Integer. Starting historical year from which to sample</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="co">#'                          projection period recruitment during forecast.</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fwd_yrs_sel Integer vector. The historical data years over which</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co">#'                    catch selection-at-age is averaged for use during forecast.</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co">#'                    Defaults to -3:-1.</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fwd_yrs_lf_remove Integer Vector. ... Defaults to -2:-1.</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param fwd_splitLD Logical. Defaults to \code{TRUE}</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="co"># === Creating forecast function ===</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>forecast_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(stk, tracking, ctrl,</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>                         args,  <span class="co"># contains ay (assessment year) and management lag</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_trgt =</span> <span class="fu">c</span>(<span class="st">"fsq"</span>, <span class="st">"hcr"</span>), <span class="co"># fish to status quo (fsq) in </span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># intermediate year and then apply hcr in final calculations</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_yrs =</span> <span class="dv">2</span>,                <span class="co"># number of years to add </span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># - have a space for the year inbetween to do intermediate </span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># calculations and then for the year we want a quota for</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_yrs_fsq =</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">0</span>,         <span class="co"># years used to calculate fsq</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_yrs_average =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:</span><span class="dv">0</span>,     <span class="co"># years used for averages</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_yrs_rec_start =</span> <span class="cn">NULL</span>, <span class="co"># recruitment - </span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># null uses the entire history to estimate</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_yrs_sel =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:-</span><span class="dv">1</span>,        <span class="co"># selectivity of equipment </span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># - average form 3 years ago to 1 year ago </span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_yrs_lf_remove =</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">:-</span><span class="dv">1</span>,  <span class="co"># calculate landings to discards</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># ratio from 2 years ago to 1 year ago</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a>                         <span class="at">fwd_splitLD =</span> <span class="cn">TRUE</span>)         <span class="co"># Whether to calculate landings </span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a>                         <span class="co"># and discards separately</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>{  </span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get current assessment year</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>  ay <span class="ot">&lt;-</span> args<span class="sc">$</span>ay</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get management lag</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>  mlag <span class="ot">&lt;-</span> args<span class="sc">$</span>management_lag</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>  <span class="do">## checking number of iterations</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>  niter <span class="ot">&lt;-</span> <span class="fu">dim</span>(stk)[<span class="dv">6</span>]  </span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>  <span class="do">## geomean to estimate recruitment for the stock</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  sr0 <span class="ot">&lt;-</span> <span class="fu">as.FLSR</span>(stk, <span class="at">model =</span> <span class="st">"geomean"</span>)</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>  sr0<span class="sc">@</span>params <span class="ot">&lt;-</span> FLCore<span class="sc">::</span><span class="fu">propagate</span>(sr0<span class="sc">@</span>params, <span class="at">iter =</span> niter)</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fwd_yrs_rec_start)) {</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    stk_n <span class="ot">&lt;-</span> <span class="fu">window</span>(stk<span class="sc">@</span>stock.n, <span class="at">start =</span> fwd_yrs_rec_start)</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>    stk_n <span class="ot">&lt;-</span> stk<span class="sc">@</span>stock.n</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>  sr0<span class="sc">@</span>params[] <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="fu">yearMeans</span>(<span class="fu">log</span>(stk_n[<span class="dv">1</span>,])))</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>  <span class="do">## remnove years before first data year</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>  minyr <span class="ot">&lt;-</span> <span class="fu">dims</span>(stk<span class="sc">@</span>stock[<span class="sc">!</span><span class="fu">is.na</span>(stk<span class="sc">@</span>stock.n)])<span class="sc">$</span>minyear <span class="co"># min year where data exists</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>  stk0  <span class="ot">&lt;-</span> <span class="fu">window</span>(stk, <span class="at">start =</span> minyr)</span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extend stock object and fill with assumptions calculated based on</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># variables defined in function call use fwd_yrs+1 because we need to </span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>  <span class="co"># see if the stock crashes at the start of the year after the advice year</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>  stk0 <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">stf</span>(stk0, fwd_yrs<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># FLasher::fwd will throw an error if there are NAs in weights in future years.</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># I need to zero these if associated numbers are zero</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>  FLCore<span class="sc">::</span><span class="fu">discards.wt</span>(stk0)[FLCore<span class="sc">::</span><span class="fu">discards.n</span>(stk0) <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>  FLCore<span class="sc">::</span><span class="fu">landings.wt</span>(stk0)[FLCore<span class="sc">::</span><span class="fu">landings.n</span>(stk0) <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>  <span class="do">## find status quo F for each stock</span></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>  fsq <span class="ot">&lt;-</span> <span class="fu">yearMeans</span>(<span class="fu">fbar</span>(stk)[,<span class="fu">as.character</span>(fwd_yrs_fsq<span class="sc">+</span>ay<span class="sc">-</span>mlag)])</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>  <span class="do">## FLasher cannot handle fsq=0</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>  fsq <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(fsq<span class="sc">==</span><span class="dv">0</span>, <span class="fl">0.001</span>,fsq)</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Construct matrix with rows as years and columns as iterations as before</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and fill it with the Ftarget values</span></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>  targ <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span>fwd_yrs<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> niter)</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>  targ[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fsq</span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>  targ[<span class="dv">2</span>,] <span class="ot">&lt;-</span> ctrl<span class="sc">@</span>iters[,<span class="st">"value"</span>,]</span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>  targ[<span class="dv">3</span>,] <span class="ot">&lt;-</span> ctrl<span class="sc">@</span>iters[,<span class="st">"value"</span>,]</span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>  <span class="co"># year sets the timeline, quant = fbar says we are using fishing mortality</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>  ctrl0 <span class="ot">&lt;-</span> <span class="fu">fwdControl</span>(<span class="fu">list</span>(<span class="at">year  =</span> <span class="fu">c</span>(ay,ctrl<span class="sc">@</span>target<span class="sc">$</span>year,ctrl<span class="sc">@</span>target<span class="sc">$</span>year<span class="sc">+</span><span class="dv">1</span>), </span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>                           <span class="at">quant =</span> <span class="st">"fbar"</span>, <span class="at">value =</span> <span class="fu">c</span>(targ)))</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>  <span class="do">## project stock forward</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>  stk_fwd <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">fwd</span>(stk0, <span class="at">sr =</span> sr0, <span class="at">control =</span> ctrl0)</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extract catch target for the advice year (3 decimal places) </span></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># by looking at the result object</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>  TAC <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">catch</span>(stk_fwd)[,<span class="fu">ac</span>(ay<span class="sc">+</span>mlag)]),<span class="dv">3</span>)</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Get SSB at the end of the advice year (or at the start of the year after?)</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>  TACyr_ssb <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">ssb</span>(stk_fwd)[,<span class="fu">ac</span>(ay<span class="sc">+</span>mlag<span class="sc">+</span><span class="dv">1</span>)])</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Find iterations where SSB at end of TAC year is &lt; Blim</span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>  belowBlim <span class="ot">&lt;-</span> <span class="fu">which</span>(TACyr_ssb <span class="sc">&lt;</span> <span class="fu">attr</span>(ctrl, <span class="st">"Blim"</span>))</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Go through model fits - where SSB &lt; Blim, forecast to target Blim</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(belowBlim) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    <span class="do">## define forward control targetting Blim</span></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>    targ <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,<span class="at">nrow=</span>fwd_yrs<span class="sc">+</span><span class="dv">1</span>, <span class="at">ncol =</span> niter)</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">1</span>,] <span class="ot">&lt;-</span> fsq</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># target is now Blim</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">2</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">attr</span>(ctrl,<span class="st">"Blim"</span>))</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>    targ[<span class="dv">3</span>,] <span class="ot">&lt;-</span> ctrl<span class="sc">@</span>iters[,<span class="st">"value"</span>,]</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>    ctrl_blim <span class="ot">&lt;-</span> <span class="fu">fwdControl</span>(<span class="fu">list</span>(</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>      <span class="at">year  =</span> <span class="fu">c</span>(ay,ay<span class="sc">+</span>mlag,ay<span class="sc">+</span>mlag<span class="sc">+</span><span class="dv">1</span>),</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>      <span class="co">#focus on biomass in the 2nd year to force us to end </span></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>      <span class="co"># at Blim instead if we were below</span></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>      <span class="at">quant =</span> <span class="fu">c</span>(<span class="st">"fbar"</span>,<span class="st">"ssb_end"</span>,<span class="st">"fbar"</span>),</span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>      <span class="at">value =</span> <span class="fu">c</span>(targ)))</span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">#rerun simulation focusing on Blim to find the Ftarget that is appropriate</span></span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>    stk_blim <span class="ot">&lt;-</span> FLasher<span class="sc">::</span><span class="fu">fwd</span>(stk0, <span class="at">sr =</span> sr0, <span class="at">control =</span> ctrl_blim)</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Find iterations with zero TAC advice (some stocks may be in such</span></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bad health taht we can't catch any)</span></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>    zeroTAC <span class="ot">&lt;-</span> <span class="fu">ssb</span>(stk_blim)[,<span class="fu">ac</span>(ay<span class="sc">+</span>mlag<span class="sc">+</span><span class="dv">1</span>)] <span class="sc">&lt;</span> <span class="fu">attr</span>(ctrl,<span class="st">"Blim"</span>)</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>    <span class="do">## update TAC</span></span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>    TAC[belowBlim] <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">c</span>(<span class="fu">catch</span>(stk_blim)[,<span class="fu">ac</span>(ay<span class="sc">+</span>mlag)])[belowBlim],<span class="dv">3</span>)</span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set any in zeroTAC to zero manually</span></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>    TAC[zeroTAC]   <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Construct fwd control object, which we measurre using catch not fbar now</span></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>  ctrl0 <span class="ot">&lt;-</span> <span class="fu">fwdControl</span>(<span class="fu">list</span>(<span class="at">year =</span> ay <span class="sc">+</span> mlag, <span class="at">quant =</span> <span class="st">"catch"</span>, <span class="at">value =</span> TAC))</span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return the same objects as before</span></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">ctrl =</span> ctrl0, <span class="at">tracking =</span> tracking))</span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="setting-forecast-arguments" class="level4">
<h4 class="anchored" data-anchor-id="setting-forecast-arguments">Setting forecast arguments</h4>
<p>This is how we find the average values for the parameters from the historical data in this simulation. It is similar to the <code>stfMixME</code> function we used beforehand, but here we can set it up separately for each stock.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set Forecast/ISYS Arguments</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Using similar settings to Cod/Had and those defined in ICES_HCR function for whiting</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>input<span class="sc">$</span>ctrl_obj<span class="sc">$</span>isys<span class="sc">@</span>args<span class="sc">$</span>isysList <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">cod =</span> <span class="fu">list</span>(<span class="at">fwd_trgt =</span> <span class="fu">c</span>(<span class="st">"fsq"</span>, <span class="st">"hcr"</span>), <span class="at">fwd_yrs =</span> <span class="dv">2</span>, <span class="at">fwd_yrs_fsq =</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">0</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">fwd_yrs_average =</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">0</span>, <span class="at">fwd_yrs_rec_start =</span> <span class="dv">2015</span>, </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">fwd_yrs_sel =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:-</span><span class="dv">1</span>),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">had =</span> <span class="fu">list</span>(<span class="at">fwd_trgt =</span> <span class="fu">c</span>(<span class="st">"fsq"</span>, <span class="st">"hcr"</span>), <span class="at">fwd_yrs =</span> <span class="dv">2</span>, <span class="at">fwd_yrs_fsq =</span> <span class="dv">0</span>,</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">fwd_yrs_average =</span> <span class="sc">-</span><span class="dv">2</span><span class="sc">:</span><span class="dv">0</span>, <span class="at">fwd_yrs_rec_start =</span> <span class="dv">1993</span>, </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">fwd_yrs_sel =</span> <span class="sc">-</span><span class="dv">3</span><span class="sc">:-</span><span class="dv">1</span>)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
</section>
<section id="parallelisation" class="level2">
<h2 class="anchored" data-anchor-id="parallelisation">Parallelisation</h2>
<p>This process has been set up so that it is easy to run in parallel. We are able to load in the data we need once and then run the simulations for each point we have chosen to sample in the round in parallel. As they run, each process only gathers the values we need and removes the rest of the results of the simulation to save memory. Here, the values we need are the <span class="math inline">\(min(SSB)\)</span> for cod, the <span class="math inline">\(min(SSB)\)</span> for haddock and the total catch of cod and haddock all over the years 2030-2039.</p>
<p>Then, we collect these results and set up the GPs for each of them. After this, we run through the process of removing any implausible points and selecting the points to sample in the next round in a very similar way to the first half of this project. We iterate this process until the optimal point(s) are found. - TACKLE WHEN I AM ABLE TO TACKLE WHY I AM GETTING MULTIPLE POINTS AS AN ANSWER (LIKELY DUE TO HAVING SAME FCOD AND COD BEING THE CHOKE?)</p>
<p>The process above makes up one run of the script. To ensure that we are consistently receiving the same point(s) as our optimal point(s), we want to follow on from the original paper and run this script 1000 times <span class="citation" data-cites="Originalpaper">(<a href="#ref-Originalpaper" role="doc-biblioref">Spence 2025</a>)</span>. This requires a new kind of parallelisation. We were able to accomplish this by creating an array of jobs which will run when there is free space on the Viking HPC used by the Univeristy of York <span class="citation" data-cites="VikingDocumentation">(<a href="#ref-VikingDocumentation" role="doc-biblioref">York, n.d.</a>)</span>. This allowed us to submit one job that would run the script 1000 times, making it a lot easier to do this than having to submit 1000 separate jobs <span class="citation" data-cites="VikingDocumentation">(<a href="#ref-VikingDocumentation" role="doc-biblioref">York, n.d.</a>)</span>. - SAY ABOUT MY 50 THROTTLE AS WELL?</p>
<p>We will now briefly explain the code for this. Firstly, we have the <code>doOne</code> function which runs the simulation for one of the points we have chosen to sample that round <span class="citation" data-cites="ParallelandOtherSimulationsInRMadeEasy">(<a href="#ref-ParallelandOtherSimulationsInRMadeEasy" role="doc-biblioref">Hofert and Mächler 2016</a>)</span>. Note that we must first load in the libraries so that the worker has access to them, similarly to how we must provide the <code>input_data</code> and <code>run_id</code>. Also note that we remove the large result object (<code>res</code>) once we have the values we need to return.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This is the function that will eventually run on each core</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>doOne <span class="ot">&lt;-</span> <span class="cf">function</span>(run_id,input_data) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Fixing could not find functions error in runners by loading libraries - DO NOT REMOVE</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(FLCore)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(FLFishery)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(mse)  </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(stockassessment)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MixME)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(DiceKriging)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Retrieve the specific inputs for this run ID</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We use the 'frozen' input_data table and pick the row matching run_id</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  this_Fcod <span class="ot">&lt;-</span> input_data<span class="sc">$</span>Fcod[run_id]</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  this_Fhad <span class="ot">&lt;-</span> input_data<span class="sc">$</span>Fhad[run_id]</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Run the simulation</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">obj_func</span>(<span class="at">f_cod =</span> this_Fcod, <span class="at">f_had =</span> this_Fhad, <span class="at">mixedfishery_MixME_om =</span> mixedfishery_MixME_om, <span class="at">stk_oem =</span> stk_oem)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get Catch directly from the 'tracking' object</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  catch_cod <span class="ot">&lt;-</span> <span class="fu">sum</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>cod<span class="sc">$</span>stk[<span class="st">"C.om"</span>, <span class="fu">ac</span>(<span class="dv">2030</span><span class="sc">:</span><span class="dv">2039</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  catch_had <span class="ot">&lt;-</span> <span class="fu">sum</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>had<span class="sc">$</span>stk[<span class="st">"C.om"</span>, <span class="fu">ac</span>(<span class="dv">2030</span><span class="sc">:</span><span class="dv">2039</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate total catch</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  total_catch <span class="ot">&lt;-</span> catch_cod <span class="sc">+</span> catch_had</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="do">## // Extract the min ssb at the last ten years of the simulation for both stocks //</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Picking up long term SSB values to see if they dip below Blim at any point</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    ssb_cod_data <span class="ot">&lt;-</span> <span class="fu">c</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>cod<span class="sc">$</span>stk[<span class="st">"SB.om"</span>, <span class="fu">ac</span>(<span class="dv">2030</span><span class="sc">:</span><span class="dv">2039</span>)])</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    ssb_had_data <span class="ot">&lt;-</span> <span class="fu">c</span>(res<span class="sc">$</span>tracking<span class="sc">$</span>had<span class="sc">$</span>stk[<span class="st">"SB.om"</span>, <span class="fu">ac</span>(<span class="dv">2030</span><span class="sc">:</span><span class="dv">2039</span>)])</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Getting minimums to model with GPs</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    ssb_cod_min <span class="ot">&lt;-</span> <span class="fu">min</span>(ssb_cod_data, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    ssb_had_min <span class="ot">&lt;-</span> <span class="fu">min</span>(ssb_had_data, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Safety Ctahc for if the simulation failed or produced all NAs</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.infinite</span>(ssb_cod_min) <span class="sc">|</span> <span class="fu">is.na</span>(ssb_cod_min)) ssb_cod_min <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">is.infinite</span>(ssb_had_min) <span class="sc">|</span> <span class="fu">is.na</span>(ssb_had_min)) ssb_had_min <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># free up memory now that we have the data we need from res</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span>(res)   </span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set up variable to return</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>  to_return <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">Fcod =</span> this_Fcod,<span class="at">Fhad =</span> this_Fhad,<span class="at">SSBCod =</span> ssb_cod_min,<span class="at">SSBHad =</span> ssb_had_min,<span class="at">TotalCatch =</span> total_catch)</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return the result</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(to_return)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We currently run this on <code>n_cores</code> which is one less than the number of cores we can detect the computer has as we needed to keep our computer running during initial testing.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>n_cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>For each round, we are sampling <code>2 * n_cores</code> points. We are able to apply this <code>doOne</code> function to each of these points using the <code>doMclapply</code> function <span class="citation" data-cites="ParallelandOtherSimulationsInRMadeEasy">(<a href="#ref-ParallelandOtherSimulationsInRMadeEasy" role="doc-biblioref">Hofert and Mächler 2016</a>)</span>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run all the points in parallel, one at a time one each core</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">doMclapply</span>(points_to_run,<span class="at">doOne =</span> doOne,<span class="at">cores =</span> n_cores)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This means we can run each <code>doOne</code> on a different core and the first argument provides the data <span class="citation" data-cites="ParallelandOtherSimulationsInRMadeEasy">(<a href="#ref-ParallelandOtherSimulationsInRMadeEasy" role="doc-biblioref">Hofert and Mächler 2016</a>)</span>. Unfortunately, this method does not work on Windows because it relies on forking <span class="citation" data-cites="ParallelandOtherSimulationsInRMadeEasy">(<a href="#ref-ParallelandOtherSimulationsInRMadeEasy" role="doc-biblioref">Hofert and Mächler 2016</a>)</span>.</p>
</section>
</section>
<section id="further-areas-for-development" class="level1">
<h1>Further areas for Development</h1>
<section id="moving-to-a-more-complicated-dataset" class="level2">
<h2 class="anchored" data-anchor-id="moving-to-a-more-complicated-dataset">Moving to a more complicated dataset</h2>
<p>Mention the one in the MixME paper.</p>
</section>
<section id="doing-a-proper-risk-calculation" class="level2">
<h2 class="anchored" data-anchor-id="doing-a-proper-risk-calculation">Doing a proper risk calculation</h2>
<p>I now meet precautionary, so would it be much of an improvement to use probabilities instead?</p>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-ParallelandOtherSimulationsInRMadeEasy" class="csl-entry" role="listitem">
Hofert, Marius, and Martin Mächler. 2016. <span>“Parallel and Other Simulations in r Made Easy: An End-to-End Study.”</span> <em>Journal of Statistical Software</em> 69 (4): 1–44. <a href="https://doi.org/10.18637/jss.v069.i04">https://doi.org/10.18637/jss.v069.i04</a>.
</div>
<div id="ref-ICES2019WKGMSE2" class="csl-entry" role="listitem">
ICES. 2019a. <span>“<span class="nocase">Workshop on Guidelines for Management Strategy Evaluations (WKGMSE2)</span>,”</span> January. <a href="https://doi.org/10.17895/ices.pub.5531">https://doi.org/10.17895/ices.pub.5531</a>.
</div>
<div id="ref-ICES2019HaddockAdvice" class="csl-entry" role="listitem">
———. 2019b. <span>“<span class="nocase">Haddock (Melanogrammus aeglefinus) in divisions 7.b–k (southern Celtic Seas and English Channel)</span>,”</span> June. <a href="https://doi.org/10.17895/ices.advice.4785">https://doi.org/10.17895/ices.advice.4785</a>.
</div>
<div id="ref-ICES2019CodAdvice" class="csl-entry" role="listitem">
———. 2019c. <span>“<span class="nocase">Cod (Gadus morhua) in Subarea 4, Division 7.d, and Subdivision 20 (North Sea, eastern English Channel, Skagerrak)</span>,”</span> November. <a href="https://doi.org/10.17895/ices.advice.5640">https://doi.org/10.17895/ices.advice.5640</a>.
</div>
<div id="ref-ICES2020CodBlim" class="csl-entry" role="listitem">
———. 2020a. <span>“<span class="nocase">Cod (Gadus morhua) in Subarea 4, Division 7.d, and Subdivision 20 (North Sea, eastern English Channel, Skagerrak)</span>,”</span> June. <a href="https://doi.org/10.17895/ices.advice.5891">https://doi.org/10.17895/ices.advice.5891</a>.
</div>
<div id="ref-ICES2020HaddockBlim" class="csl-entry" role="listitem">
———. 2020b. <span>“<span class="nocase">Haddock (Melanogrammus aeglefinus) in divisions 7.b–k (southern Celtic Seas and English Channel)</span>,”</span> October. <a href="https://doi.org/10.17895/ices.advice.5897">https://doi.org/10.17895/ices.advice.5897</a>.
</div>
<div id="ref-ICES2021Cod028" class="csl-entry" role="listitem">
———. 2021. <span>“<span class="nocase">Benchmark Workshop on North Sea Stocks (WKNSEA)</span>,”</span> April. <a href="https://doi.org/10.17895/ices.pub.7922">https://doi.org/10.17895/ices.pub.7922</a>.
</div>
<div id="ref-ICESCodFactsheet" class="csl-entry" role="listitem">
———. n.d. <span>“ICES-FishMap Cod.”</span> <a href="https://www.ices.dk/about-ICES/projects/EU-RFP/EU%20Repository/ICES%20FIshMap/ICES%20FishMap%20species%20factsheet-cod.pdf">https://www.ices.dk/about-ICES/projects/EU-RFP/EU%20Repository/ICES%20FIshMap/ICES%20FishMap%20species%20factsheet-cod.pdf</a>.
</div>
<div id="ref-MixMEwiki" class="csl-entry" role="listitem">
Pace, Matthew. 2024. <span>“MixME Wiki.”</span> <a href="https://github.com/CefasRepRes/MixME/wiki">https://github.com/CefasRepRes/MixME/wiki</a>.
</div>
<div id="ref-MixME" class="csl-entry" role="listitem">
Pace, Matthew, José Oliveira, Simon Fischer, and Paul Dolder. 2025a. <span>“MixME: An r Package to Simulation‐test Fisheries Management Robustness to Mixed‐fisheries Interactions.”</span> <em>Methods in Ecology and Evolution</em> 16 (February): 698–706. <a href="https://doi.org/10.1111/2041-210X.70005">https://doi.org/10.1111/2041-210X.70005</a>.
</div>
<div id="ref-MixMESupp" class="csl-entry" role="listitem">
———. 2025b. <span>“"Supplementary Material a: Conditioning a Multi-Stock, Multi-Fleet Operating Model for Celtic Sea Cod, Haddock and Whiting",”</span> February. <a href="https://besjournals.onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1111%2F2041-210X.70005&amp;file=mee370005-sup-0001-Supinfo1.pdf">https://besjournals.onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1111%2F2041-210X.70005&amp;file=mee370005-sup-0001-Supinfo1.pdf</a>.
</div>
<div id="ref-DiceKrigingPaper" class="csl-entry" role="listitem">
Roustant, Olivier, David Ginsbourger, and Yves Deville. 2012. <span>“DiceKriging, DiceOptim: Two r Packages for the Analysis of Computer Experiments by Kriging-Based Metamodeling and Optimization.”</span> <em>Journal of Statistical Software</em> 51 (1): 1–55. <a href="https://doi.org/10.18637/jss.v051.i01">https://doi.org/10.18637/jss.v051.i01</a>.
</div>
<div id="ref-Originalpaper" class="csl-entry" role="listitem">
Spence, Michael A. 2025. <span>“Using History Matching to Speed up Management Strategy Evaluation Grid Searches.”</span> <em>Canadian Journal of Fisheries and Aquatic Sciences</em> 82: 1–14. <a href="https://doi.org/10.1139/cjfas-2024-0191">https://doi.org/10.1139/cjfas-2024-0191</a>.
</div>
<div id="ref-ULRICH201238" class="csl-entry" role="listitem">
Ulrich, Clara, Douglas C. K. Wilson, J. Rasmus Nielsen, Francois Bastardie, Stuart A. Reeves, Bo S. Andersen, and Ole R. Eigaard. 2012. <span>“Challenges and Opportunities for Fleet- and Métier-Based Approaches for Fisheries Management Under the European Common Fishery Policy.”</span> <em>Ocean &amp; Coastal Management</em> 70: 38–47. https://doi.org/<a href="https://doi.org/10.1016/j.ocecoaman.2012.06.002">https://doi.org/10.1016/j.ocecoaman.2012.06.002</a>.
</div>
<div id="ref-williams2006gaussian" class="csl-entry" role="listitem">
Williams, Christopher KI, and Carl Edward Rasmussen. 2006. <em>Gaussian Processes for Machine Learning</em>. Vol. 2. 3. MIT press Cambridge, MA.
</div>
<div id="ref-VikingDocumentation" class="csl-entry" role="listitem">
York, University of. n.d. <span>“Viking Documentation.”</span> <a href="https://vikingdocs.york.ac.uk/index.html">https://vikingdocs.york.ac.uk/index.html</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>